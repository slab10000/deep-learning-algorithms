<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Models - Classification & Regression</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: transparent;
            color: #666;
        }

        .tab.active {
            color: white;
            position: relative;
        }

        .tab.active.classifier {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab.active.regressor {
            background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header.classifier {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .header.regressor {
            background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-container {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group.regressor input:focus,
        .form-group.regressor select:focus {
            border-color: #1db954;
        }

        .form-group small {
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
        }

        /* Slider Styles */
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: background 0.3s;
        }

        .regressor .slider::-webkit-slider-thumb {
            background: #1db954;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        .regressor .slider::-moz-range-thumb {
            background: #1db954;
        }

        .slider-value {
            min-width: 60px;
            text-align: right;
            font-weight: 600;
            color: #333;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .submit-btn.regressor {
            background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn.regressor:hover {
            box-shadow: 0 10px 20px rgba(29, 185, 84, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-container {
            margin-top: 30px;
            padding: 25px;
            border-radius: 12px;
            display: none;
        }

        .result-container.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .result-danger {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .result-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        .result-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .result-probability {
            margin-top: 15px;
            font-size: 1.1em;
        }

        .probability-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .probability-fill.regressor {
            background: linear-gradient(90deg, #1db954 0%, #1ed760 100%);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .spinner.regressor {
            border-top-color: #1db954;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active classifier" onclick="switchTab('classifier')">üêæ Classifier</button>
            <button class="tab regressor" onclick="switchTab('regressor')">üéµ Regressor</button>
        </div>

        <!-- Classifier Tab -->
        <div id="classifierTab" class="tab-content active">
            <div class="header classifier">
                <h1>üêæ Pet Adoption Predictor</h1>
                <p>Predict the likelihood of a pet being adopted</p>
            </div>

            <div class="form-container">
                <form id="predictionForm">
                    <div class="form-grid">
                        <!-- Type -->
                        <div class="form-group">
                            <label for="type">Pet Type *</label>
                            <select id="type" name="type" required>
                                <option value="">Select...</option>
                                <option value="0">Cat</option>
                                <option value="1">Dog</option>
                            </select>
                            <small>Cat=0, Dog=1</small>
                        </div>

                        <!-- Age -->
                        <div class="form-group">
                            <label for="age">Age (in months) *</label>
                            <input type="number" id="age" name="age" min="0" max="120" required>
                            <small>Will be converted to age bucket (0-5)</small>
                        </div>

                        <!-- Breed1 -->
                        <div class="form-group">
                            <label for="breed1">Breed *</label>
                            <select id="breed1" name="breed1" required>
                                <option value="">Select breed...</option>
                            </select>
                            <small>Select the pet's breed</small>
                        </div>

                        <!-- Gender -->
                        <div class="form-group">
                            <label for="gender">Gender *</label>
                            <select id="gender" name="gender" required>
                                <option value="">Select...</option>
                                <option value="0">Male</option>
                                <option value="1">Female</option>
                            </select>
                            <small>Male=0, Female=1</small>
                        </div>

                        <!-- Color1 -->
                        <div class="form-group">
                            <label for="color1">Primary Color *</label>
                            <select id="color1" name="color1" required>
                                <option value="">Select...</option>
                                <option value="0">Black</option>
                                <option value="1">Brown</option>
                                <option value="2">Cream</option>
                                <option value="3">Gray</option>
                                <option value="4">Golden</option>
                                <option value="5">White</option>
                                <option value="6">Yellow</option>
                            </select>
                            <small>Primary color of the pet</small>
                        </div>

                        <!-- Color2 -->
                        <div class="form-group">
                            <label for="color2">Secondary Color *</label>
                            <select id="color2" name="color2" required>
                                <option value="">Select...</option>
                                <option value="0">White</option>
                                <option value="1">Brown</option>
                                <option value="2">No Color</option>
                                <option value="3">Gray</option>
                                <option value="4">Cream</option>
                                <option value="5">Golden</option>
                                <option value="6">Yellow</option>
                            </select>
                            <small>Secondary color (or "No Color")</small>
                        </div>

                        <!-- MaturitySize -->
                        <div class="form-group">
                            <label for="maturitySize">Maturity Size *</label>
                            <select id="maturitySize" name="maturitySize" required>
                                <option value="">Select...</option>
                                <option value="0">Small</option>
                                <option value="1">Medium</option>
                                <option value="2">Large</option>
                            </select>
                            <small>Expected adult size</small>
                        </div>

                        <!-- FurLength -->
                        <div class="form-group">
                            <label for="furLength">Fur Length *</label>
                            <select id="furLength" name="furLength" required>
                                <option value="">Select...</option>
                                <option value="0">Short</option>
                                <option value="1">Medium</option>
                                <option value="2">Long</option>
                            </select>
                            <small>Length of fur/coat</small>
                        </div>

                        <!-- Vaccinated -->
                        <div class="form-group">
                            <label for="vaccinated">Vaccinated *</label>
                            <select id="vaccinated" name="vaccinated" required>
                                <option value="">Select...</option>
                                <option value="0">No / Not Sure</option>
                                <option value="1">Yes</option>
                            </select>
                            <small>No/Not Sure=0, Yes=1</small>
                        </div>

                        <!-- Sterilized -->
                        <div class="form-group">
                            <label for="sterilized">Sterilized *</label>
                            <select id="sterilized" name="sterilized" required>
                                <option value="">Select...</option>
                                <option value="0">No</option>
                                <option value="1">Not Sure</option>
                                <option value="2">Yes</option>
                            </select>
                            <small>Sterilization status</small>
                        </div>

                        <!-- Health -->
                        <div class="form-group">
                            <label for="health">Health Status *</label>
                            <select id="health" name="health" required>
                                <option value="">Select...</option>
                                <option value="0">Healthy</option>
                                <option value="1">Minor Injury</option>
                                <option value="2">Serious Injury</option>
                            </select>
                            <small>Current health condition</small>
                        </div>

                        <!-- Fee -->
                        <div class="form-group">
                            <label for="fee">Adoption Fee *</label>
                            <input type="number" id="fee" name="fee" min="0" required>
                            <small>Adoption fee in local currency</small>
                        </div>

                        <!-- PhotoAmt -->
                        <div class="form-group">
                            <label for="photoAmt">Number of Photos *</label>
                            <input type="number" id="photoAmt" name="photoAmt" min="0" required>
                            <small>Number of photos available</small>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">Predict Adoption Likelihood</button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">Loading model and making prediction...</p>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="result-container" id="resultContainer">
                    <div class="result-title" id="resultTitle"></div>
                    <div id="resultText"></div>
                    <div class="result-probability">
                        <strong>Model Confidence:</strong>
                        <div class="probability-bar">
                            <div class="probability-fill" id="probabilityFill"></div>
                        </div>
                    </div>
                    <div class="model-metrics" id="modelMetrics" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <div style="font-size: 0.9em; color: #666;">
                            <strong>Model Performance:</strong>
                            <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div>Precision: <strong>73.2%</strong></div>
                                <div>Recall: <strong>66.8%</strong></div>
                                <div>F1-Score: <strong>68.6%</strong></div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em; font-style: italic;">
                                Note: These metrics reflect the model's overall performance on the test set.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Regressor Tab -->
        <div id="regressorTab" class="tab-content">
            <div class="header regressor">
                <h1>üéµ Song Popularity Predictor</h1>
                <p>Predict the popularity of a song based on audio features</p>
            </div>

            <div class="form-container regressor">
                <form id="regressionForm">
                    <div class="form-grid">
                        <!-- Duration -->
                        <div class="form-group regressor">
                            <label for="duration_ms">Duration (ms) *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="duration_ms" name="duration_ms" min="0" max="600000" value="200000" step="1000" class="slider" required>
                                    <span class="slider-value" id="duration_ms_value">200000</span>
                                </div>
                            </div>
                            <small>Song duration in milliseconds</small>
                        </div>

                        <!-- Danceability -->
                        <div class="form-group regressor">
                            <label for="danceability">Danceability *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="danceability" name="danceability" min="0" max="1" value="0.5" step="0.01" class="slider" required>
                                    <span class="slider-value" id="danceability_value">0.50</span>
                                </div>
                            </div>
                            <small>How suitable a track is for dancing (0-1)</small>
                        </div>

                        <!-- Energy -->
                        <div class="form-group regressor">
                            <label for="energy">Energy *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="energy" name="energy" min="0" max="1" value="0.5" step="0.01" class="slider" required>
                                    <span class="slider-value" id="energy_value">0.50</span>
                                </div>
                            </div>
                            <small>Perceptual measure of intensity and power (0-1)</small>
                        </div>

                        <!-- Key -->
                        <div class="form-group regressor">
                            <label for="key">Key *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="key" name="key" min="0" max="11" value="5" step="1" class="slider" required>
                                    <span class="slider-value" id="key_value">5</span>
                                </div>
                            </div>
                            <small>Key of the track (0=C, 1=C#, ..., 11=B)</small>
                        </div>

                        <!-- Loudness -->
                        <div class="form-group regressor">
                            <label for="loudness">Loudness (dB) *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="loudness" name="loudness" min="-60" max="0" value="-10" step="0.1" class="slider" required>
                                    <span class="slider-value" id="loudness_value">-10.0</span>
                                </div>
                            </div>
                            <small>Overall loudness in decibels (-60 to 0)</small>
                        </div>

                        <!-- Mode -->
                        <div class="form-group regressor">
                            <label for="mode">Mode *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="mode" name="mode" min="0" max="1" value="1" step="1" class="slider" required>
                                    <span class="slider-value" id="mode_value">1</span>
                                </div>
                            </div>
                            <small>Major (1) or Minor (0)</small>
                        </div>

                        <!-- Speechiness -->
                        <div class="form-group regressor">
                            <label for="speechiness">Speechiness *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="speechiness" name="speechiness" min="0" max="1" value="0.05" step="0.01" class="slider" required>
                                    <span class="slider-value" id="speechiness_value">0.05</span>
                                </div>
                            </div>
                            <small>Presence of spoken words (0-1)</small>
                        </div>

                        <!-- Acousticness -->
                        <div class="form-group regressor">
                            <label for="acousticness">Acousticness *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="acousticness" name="acousticness" min="0" max="1" value="0.5" step="0.01" class="slider" required>
                                    <span class="slider-value" id="acousticness_value">0.50</span>
                                </div>
                            </div>
                            <small>Confidence measure of whether track is acoustic (0-1)</small>
                        </div>

                        <!-- Instrumentalness -->
                        <div class="form-group regressor">
                            <label for="instrumentalness">Instrumentalness *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="instrumentalness" name="instrumentalness" min="0" max="1" value="0.0" step="0.01" class="slider" required>
                                    <span class="slider-value" id="instrumentalness_value">0.00</span>
                                </div>
                            </div>
                            <small>Predicts whether track contains no vocals (0-1)</small>
                        </div>

                        <!-- Tempo -->
                        <div class="form-group regressor">
                            <label for="tempo">Tempo (BPM) *</label>
                            <div class="slider-container">
                                <div class="slider-wrapper">
                                    <input type="range" id="tempo" name="tempo" min="0" max="250" value="120" step="0.1" class="slider" required>
                                    <span class="slider-value" id="tempo_value">120.0</span>
                                </div>
                            </div>
                            <small>Overall estimated tempo in beats per minute</small>
                        </div>

                    </div>

                    <button type="submit" class="submit-btn regressor" id="regressionSubmitBtn">Predict Song Popularity</button>
                </form>

                <div class="loading" id="regressionLoading">
                    <div class="spinner regressor"></div>
                    <p style="margin-top: 10px;">Loading model and making prediction...</p>
                </div>

                <div class="error-message" id="regressionErrorMessage"></div>

                <div class="result-container" id="regressionResultContainer">
                    <div class="result-title" id="regressionResultTitle"></div>
                    <div id="regressionResultText"></div>
                    <div class="result-probability">
                        <strong>Predicted Popularity Score:</strong>
                        <div class="probability-bar">
                            <div class="probability-fill regressor" id="regressionProbabilityFill"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab.${tabName}`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Update body background
            if (tabName === 'regressor') {
                document.body.style.background = 'linear-gradient(135deg, #1db954 0%, #1ed760 100%)';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // ========== CLASSIFIER CODE ==========
        let classifierSession = null;
        const classifierModelPath = './classification/mlp_net_model.onnx';

        // Breed list with mapping to indices (0-165)
        const breeds = [
            'Abyssinian', 'Akita', 'American Bulldog', 'American Curl',
            'American Shorthair', 'American Staffordshire Terrier',
            'American Water Spaniel', 'American Wirehair', 'Applehead Siamese',
            'Australian Kelpie', 'Australian Shepherd', 'Australian Terrier', 'Balinese',
            'Basenji', 'Basset Hound', 'Beagle', 'Bedlington Terrier',
            'Belgian Shepherd Dog Sheepdog', 'Belgian Shepherd Laekenois',
            'Belgian Shepherd Malinois', 'Bengal', 'Birman', 'Black Labrador Retriever',
            'Black Mouth Cur', 'Bobtail', 'Bombay', 'Border Collie', 'Boston Terrier',
            'Boxer', 'British Shorthair', 'Bull Terrier', 'Bullmastiff', 'Burmese',
            'Burmilla', 'Calico', 'Cattle Dog', 'Cavalier King Charles Spaniel',
            'Chartreux', 'Chausie', 'Chihuahua', 'Chinese Crested Dog', 'Chow Chow',
            'Cocker Spaniel', 'Collie', 'Coonhound', 'Corgi', 'Cymric', 'Dachshund',
            'Dalmatian', 'Dilute Calico', 'Dilute Tortoiseshell', 'Doberman Pinscher',
            'Domestic Long Hair', 'Domestic Medium Hair', 'Domestic Short Hair',
            'Dutch Shepherd', 'Egyptian Mau', 'English Bulldog',
            'English Cocker Spaniel', 'English Pointer', 'English Springer Spaniel',
            'Exotic Shorthair', 'Extra-Toes Cat (Hemingway Polydactyl)',
            'Field Spaniel', 'Flat-coated Retriever', 'Fox Terrier', 'Foxhound',
            'French Bulldog', 'German Pinscher', 'German Shepherd Dog', 'German Spitz',
            'Glen of Imaal Terrier', 'Golden Retriever', 'Great Dane', 'Greyhound',
            'Havana', 'Himalayan', 'Hound', 'Husky', 'Irish Setter', 'Irish Terrier',
            'Irish Wolfhound', 'Jack Russell Terrier',
            'Jack Russell Terrier (Parson Russell Terrier)', 'Japanese Bobtail',
            'Javanese', 'Kai Dog', 'Korat', 'Labrador Retriever', 'Lancashire Heeler',
            'Lhasa Apso', 'Lowchen', 'Maine Coon', 'Maltese', 'Manchester Terrier', 'Manx',
            'Mastiff', 'Miniature Pinscher', 'Mixed Breed', 'Mountain Dog',
            'Munsterlander', 'Nebelung', 'Norwegian Forest Cat', 'Ocicat',
            'Old English Sheepdog', 'Oriental Long Hair', 'Oriental Short Hair',
            'Oriental Tabby', 'Papillon', 'Pekingese', 'Persian', 'Pit Bull Terrier',
            'Pointer', 'Pomeranian', 'Poodle', 'Pug', 'Ragamuffin', 'Ragdoll',
            'Rat Terrier', 'Retriever', 'Rhodesian Ridgeback', 'Rottweiler',
            'Russian Blue', 'Saint Bernard', 'Samoyed', 'Schnauzer', 'Setter', 'Shar Pei',
            'Shepherd', 'Shetland Sheepdog Sheltie', 'Shiba Inu', 'Shih Tzu', 'Siamese',
            'Siberian', 'Siberian Husky', 'Silky Terrier', 'Silver', 'Singapura',
            'Snowshoe', 'Somali', 'Spaniel', 'Sphynx (hairless cat)', 'Spitz',
            'Staffordshire Bull Terrier', 'Standard Poodle', 'Swedish Vallhund', 'Tabby',
            'Terrier', 'Tiger', 'Tonkinese', 'Torbie', 'Tortoiseshell', 'Toy Fox Terrier',
            'Turkish Angora', 'Turkish Van', 'Tuxedo', 'Weimaraner', 'Welsh Corgi',
            'West Highland White Terrier Westie', 'Wheaten Terrier', 'Whippet',
            'White German Shepherd', 'Wirehaired Terrier', 'Yellow Labrador Retriever',
            'Yorkshire Terrier Yorkie'
        ];

        // Normalization parameters (from training)
        const x_means = [0.5816, 3.1584, 9.4218, 0.5701, 1.3431, 1.8388, 0.8858, 0.4595, 0.4514, 0.6748, 0.0490, 22.6555, 3.4510];
        const x_deviations = [0.4934, 1.9138, 19.6877, 0.4952, 1.7755, 1.6229, 0.5356, 0.5986, 0.4978, 0.8718, 0.2314, 75.6528, 3.0928];

        // Age bucketization function
        function bucketizeAge(ageInMonths) {
            if (ageInMonths <= 1) return 0;
            if (ageInMonths <= 2) return 1;
            if (ageInMonths <= 3) return 2;
            if (ageInMonths <= 4) return 3;
            if (ageInMonths <= 5) return 4;
            return 5;
        }

        // Load classifier model
        async function loadClassifierModel() {
            try {
                classifierSession = await ort.InferenceSession.create(classifierModelPath);
                console.log('Classifier model loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading classifier model:', error);
                showClassifierError('Failed to load model. Make sure mlp_net_model.onnx is in the classification folder.');
                return false;
            }
        }

        // Show error message
        function showClassifierError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        // Make classifier prediction
        async function makeClassifierPrediction(formData) {
            try {
                const age = bucketizeAge(parseInt(formData.get('age')));

                const inputArray = [
                    parseFloat(formData.get('type')),
                    age,
                    parseFloat(formData.get('breed1')),
                    parseFloat(formData.get('gender')),
                    parseFloat(formData.get('color1')),
                    parseFloat(formData.get('color2')),
                    parseFloat(formData.get('maturitySize')),
                    parseFloat(formData.get('furLength')),
                    parseFloat(formData.get('vaccinated')),
                    parseFloat(formData.get('sterilized')),
                    parseFloat(formData.get('health')),
                    parseFloat(formData.get('fee')),
                    parseFloat(formData.get('photoAmt'))
                ];

                const normalizedInput = inputArray.map((val, idx) => {
                    return (val - x_means[idx]) / (x_deviations[idx] + 0.0001);
                });

                const tensor = new ort.Tensor('float32', new Float32Array(normalizedInput), [1, 13]);
                const feeds = { input: tensor };
                const results = await classifierSession.run(feeds);
                const output = results.output.data;

                const notAdoptedProb = output[0];
                const adoptedProb = output[1];
                const isAdopted = adoptedProb > 0.5;

                return {
                    adopted: isAdopted,
                    probability: Math.max(adoptedProb, notAdoptedProb),
                    rawOutput: Array.from(output)
                };
            } catch (error) {
                console.error('Prediction error:', error);
                throw error;
            }
        }

        const modelF1 = 0.686;

        // Display classifier result
        function displayClassifierResult(prediction) {
            const resultContainer = document.getElementById('resultContainer');
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');
            const probabilityFill = document.getElementById('probabilityFill');

            resultContainer.className = 'result-container show';
            
            const rawProbability = prediction.probability;
            const adjustedConfidence = rawProbability * modelF1;
            
            if (prediction.adopted) {
                resultContainer.className += ' result-success';
                resultTitle.textContent = '‚úÖ Likely to be Adopted!';
                resultText.textContent = `This pet has a ${(rawProbability * 100).toFixed(1)}% predicted probability of being adopted. ` +
                    `Given the model's ${(modelF1 * 100).toFixed(1)}% F1-score, the adjusted confidence is ${(adjustedConfidence * 100).toFixed(1)}%.`;
            } else {
                resultContainer.className += ' result-danger';
                resultTitle.textContent = '‚ùå Less Likely to be Adopted';
                resultText.textContent = `This pet has a ${(rawProbability * 100).toFixed(1)}% predicted probability of NOT being adopted. ` +
                    `Given the model's ${(modelF1 * 100).toFixed(1)}% F1-score, the adjusted confidence is ${(adjustedConfidence * 100).toFixed(1)}%. ` +
                    `Consider adjusting features like fee, photos, or health status.`;
            }

            const percentage = (adjustedConfidence * 100).toFixed(1);
            probabilityFill.style.width = percentage + '%';
            probabilityFill.textContent = percentage + '%';
        }

        // Handle classifier form submission
        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultContainer');
            
            resultContainer.classList.remove('show');
            submitBtn.disabled = true;
            loading.classList.add('show');
            
            try {
                if (!classifierSession) {
                    const loaded = await loadClassifierModel();
                    if (!loaded) {
                        throw new Error('Model failed to load');
                    }
                }
                
                const formData = new FormData(e.target);
                const prediction = await makeClassifierPrediction(formData);
                displayClassifierResult(prediction);
                
            } catch (error) {
                console.error('Error:', error);
                showClassifierError('An error occurred during prediction: ' + error.message);
            } finally {
                loading.classList.remove('show');
                submitBtn.disabled = false;
            }
        });

        // Populate breed dropdown
        function populateBreedDropdown() {
            const breedSelect = document.getElementById('breed1');
            breeds.forEach((breed, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = breed;
                breedSelect.appendChild(option);
            });
        }

        // ========== REGRESSOR CODE ==========
        let regressorSession = null;
        const regressorModelPath = './regression/xgboost_songs_model.onnx';

        // Update slider values in real-time
        // Note: popularity is the TARGET, not an input feature
        const sliderIds = ['duration_ms', 'danceability', 'energy', 'key', 'loudness', 'mode', 'speechiness', 'acousticness', 'instrumentalness', 'tempo'];
        sliderIds.forEach(id => {
            const slider = document.getElementById(id);
            const valueDisplay = document.getElementById(id + '_value');
            if (slider && valueDisplay) {
                slider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    if (id === 'duration_ms') {
                        valueDisplay.textContent = Math.round(value).toLocaleString();
                    } else if (id === 'loudness' || id === 'tempo') {
                        valueDisplay.textContent = value.toFixed(1);
                    } else if (id === 'danceability' || id === 'energy' || id === 'speechiness' || id === 'acousticness' || id === 'instrumentalness') {
                        valueDisplay.textContent = value.toFixed(2);
                    } else {
                        valueDisplay.textContent = Math.round(value);
                    }
                });
            }
        });

        // Load regressor model
        async function loadRegressorModel() {
            try {
                regressorSession = await ort.InferenceSession.create(regressorModelPath);
                console.log('Regressor model loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading regressor model:', error);
                showRegressorError('Failed to load model. Make sure xgboost_songs_model.onnx is in the regression folder.');
                return false;
            }
        }

        // Show regressor error
        function showRegressorError(message) {
            const errorDiv = document.getElementById('regressionErrorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        // Make regressor prediction
        async function makeRegressorPrediction(formData) {
            // Prepare input array in the correct order (10 features):
            // duration_ms, danceability, energy, key, loudness, mode, speechiness, acousticness, instrumentalness, tempo
            // Note: popularity is the TARGET variable, not an input feature
            const inputArray = [
                parseFloat(formData.get('duration_ms')),
                parseFloat(formData.get('danceability')),
                parseFloat(formData.get('energy')),
                parseFloat(formData.get('key')),
                parseFloat(formData.get('loudness')),
                parseFloat(formData.get('mode')),
                parseFloat(formData.get('speechiness')),
                parseFloat(formData.get('acousticness')),
                parseFloat(formData.get('instrumentalness')),
                parseFloat(formData.get('tempo'))
            ];

            // Create tensor (XGBoost expects 2D input: [batch_size, num_features])
            // Model expects 10 features (popularity is the target, not an input)
            const tensor = new ort.Tensor('float32', new Float32Array(inputArray), [1, 10]);

            // Get the input name from the model (hummingbird models typically use 'input')
            const inputNames = regressorSession.inputNames;
            const outputNames = regressorSession.outputNames;
            
            console.log('Model input names:', inputNames);
            console.log('Model output names:', outputNames);

            // Try different input names (hummingbird typically uses 'input')
            const inputName = inputNames[0] || 'input';
            const feeds = { [inputName]: tensor };

            try {
                const results = await regressorSession.run(feeds);
                
                // Get output (regression returns a single value)
                // Try different output names
                const outputName = outputNames[0] || 'output';
                const output = results[outputName] || results.output || results.variable || Object.values(results)[0];
                const popularityScore = output.data[0];

                return {
                    popularity: popularityScore
                };
            } catch (error) {
                console.error('Prediction error:', error);
                console.error('Available input names:', inputNames);
                console.error('Available output names:', outputNames);
                throw error;
            }
        }

        // Display regressor result
        function displayRegressorResult(prediction) {
            const resultContainer = document.getElementById('regressionResultContainer');
            const resultTitle = document.getElementById('regressionResultTitle');
            const resultText = document.getElementById('regressionResultText');
            const probabilityFill = document.getElementById('regressionProbabilityFill');

            resultContainer.className = 'result-container show result-info';
            
            const popularity = Math.max(0, Math.min(100, prediction.popularity)); // Clamp between 0-100
            
            resultTitle.textContent = `üéµ Predicted Popularity: ${popularity.toFixed(1)}/100`;
            resultText.textContent = `Based on the audio features you provided, this song is predicted to have a popularity score of ${popularity.toFixed(1)} out of 100. ` +
                `Higher scores indicate greater popularity on Spotify.`;

            // Display the popularity score in the bar
            probabilityFill.style.width = popularity + '%';
            probabilityFill.textContent = popularity.toFixed(1);
        }

        // Handle regressor form submission
        document.getElementById('regressionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('regressionSubmitBtn');
            const loading = document.getElementById('regressionLoading');
            const resultContainer = document.getElementById('regressionResultContainer');
            
            resultContainer.classList.remove('show');
            submitBtn.disabled = true;
            loading.classList.add('show');
            
            try {
                if (!regressorSession) {
                    const loaded = await loadRegressorModel();
                    if (!loaded) {
                        throw new Error('Model failed to load');
                    }
                }
                
                const formData = new FormData(e.target);
                const prediction = await makeRegressorPrediction(formData);
                displayRegressorResult(prediction);
                
            } catch (error) {
                console.error('Error:', error);
                showRegressorError('An error occurred during prediction: ' + error.message);
            } finally {
                loading.classList.remove('show');
                submitBtn.disabled = false;
            }
        });

        // Load models on page load
        window.addEventListener('load', async () => {
            populateBreedDropdown();
            
            // Load classifier model
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            loading.querySelector('p').textContent = 'Loading classifier model...';
            
            try {
                await loadClassifierModel();
                loading.querySelector('p').textContent = 'Model loaded! Fill out the form to make a prediction.';
                setTimeout(() => {
                    loading.classList.remove('show');
                }, 1000);
            } catch (error) {
                loading.classList.remove('show');
                showClassifierError('Failed to load classifier model on startup. Please refresh the page.');
            }
        });
    </script>
</body>
</html>
